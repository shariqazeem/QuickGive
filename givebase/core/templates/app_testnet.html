<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umanity - Global Donation Ecosystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gray-50': '#fafafa',
                        'gray-100': '#f5f5f5',
                        'gray-200': '#e5e5e5',
                        'gray-300': '#d4d4d4',
                        'gray-400': '#a3a3a3',
                        'gray-500': '#737373',
                        'gray-600': '#525252',
                        'gray-700': '#404040',
                        'gray-800': '#262626',
                        'gray-900': '#171717',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Enhanced Animations */
        .floating {
            animation: floating 8s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            25% {
                transform: translateY(-10px) rotate(1deg);
            }
            50% {
                transform: translateY(-20px) rotate(0deg);
            }
            75% {
                transform: translateY(-10px) rotate(-1deg);
            }
        }

        .fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
            transform: translateY(50px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in-left {
            animation: slideInLeft 1s ease-out forwards;
            opacity: 0;
            transform: translateX(-50px);
        }

        @keyframes slideInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .slide-in-right {
            animation: slideInRight 1s ease-out forwards;
            opacity: 0;
            transform: translateX(50px);
        }

        @keyframes slideInRight {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #000000 0%, #404040 50%, #000000 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-text-white {
            background: linear-gradient(135deg, #ffffff 0%, #a3a3a3 50%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Premium Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .glass-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 0, 0, 0.2);
        }

        .dark-glass-card {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .dark-glass-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Buttons */
        .primary-button {
            background: linear-gradient(135deg, #000000 0%, #262626 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .primary-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .primary-button:hover:before {
            left: 100%;
        }

        .primary-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #262626 0%, #404040 100%);
        }

        .secondary-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .secondary-button:hover {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.4);
            transform: translateY(-3px);
        }

        /* Navigation */
        .nav-blur {
            backdrop-filter: blur(30px);
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        /* Logo Enhancement */
        .logo {
            font-weight: 800;
            font-size: 2rem;
            background: linear-gradient(135deg, #000000 0%, #404040 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }

        /* Pool Cards */
        .pool-card {
            background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .pool-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #000000, #404040, #000000);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .pool-card:hover:before {
            transform: scaleX(1);
        }

        .pool-card:hover {
            transform: translateY(-12px) scale(1.03);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 0, 0, 0.15);
        }

        /* Progress Bars */
        .progress-bar {
            background: linear-gradient(90deg, #000000, #404040);
            transition: width 0.8s ease;
        }

        /* Stats Enhancement */
        .stats-card {
            background: linear-gradient(145deg, #fafafa 0%, #f5f5f5 100%);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .token-highlight {
            background: linear-gradient(145deg, #000000 0%, #262626 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .token-highlight:hover {
            background: linear-gradient(145deg, #262626 0%, #404040 100%);
        }

        /* Tab Styling */
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            color: #737373;
        }

        .tab-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
            color: #000000;
        }

        .tab-active {
            background: linear-gradient(135deg, #000000 0%, #262626 100%) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* Wallet Dropdown */
        .wallet-dropdown {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        /* Donation Type Buttons */
        .donation-type-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            color: #737373;
        }

        .donation-type-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.2);
            color: #000000;
        }

        .donation-type-active {
            background: linear-gradient(135deg, #000000 0%, #262626 100%) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* Social Cards */
        .social-card {
            background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .social-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.15);
        }

        /* Leaderboard Enhancements */
        .leaderboard-item {
            background: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .user-highlight {
            background: linear-gradient(145deg, #000000 0%, #262626 100%) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* Form Inputs */
        .form-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
            outline: none;
        }

        /* Modal Styling */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }

        /* Micro Interactions */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .hover-lift:hover {
            transform: translateY(-3px);
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #000000;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Geometric Patterns */
        .geometric-bg {
            background-image:
                radial-gradient(circle at 20% 50%, rgba(0, 0, 0, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 0, 0, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(0, 0, 0, 0.02) 0%, transparent 50%);
        }

        .grid-pattern {
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Dark Section */
        .dark-section {
            background: linear-gradient(135deg, #000000 0%, #171717 50%, #000000 100%);
            position: relative;
            overflow: hidden;
        }

        .dark-section:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #000000, #404040);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #262626, #525252);
        }

        /* Enhanced Typography */
        .hero-text {
            font-weight: 900;
            line-height: 0.9;
            letter-spacing: -0.02em;
        }

        .subtitle-text {
            font-weight: 400;
            line-height: 1.6;
            letter-spacing: 0.01em;
        }

        /* Network Status */
        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
            }
        }
    </style>
</head>
<body class="bg-white text-gray-900 overflow-x-hidden geometric-bg">
    <!-- Header -->
    <header class="nav-blur sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <div class="logo">Umanity</div>
                    <nav class="hidden md:flex space-x-2">
                        <button onclick="switchTab('donate')" class="tab-btn px-4 py-2 rounded-xl transition-all text-sm font-medium" data-tab="donate">
                            <i class="fas fa-heart mr-2"></i>Donate
                        </button>
                        <button onclick="switchTab('social')" class="tab-btn px-4 py-2 rounded-xl transition-all text-sm font-medium" data-tab="social">
                            <i class="fas fa-users mr-2"></i>Social Feed
                        </button>
                        <button onclick="switchTab('leaderboard')" class="tab-btn px-4 py-2 rounded-xl transition-all text-sm font-medium" data-tab="leaderboard">
                            <i class="fas fa-trophy mr-2"></i>Leaderboard
                        </button>
                        <button onclick="switchTab('my-donations')" class="tab-btn px-4 py-2 rounded-xl transition-all text-sm font-medium" data-tab="my-donations">
                            <i class="fas fa-history mr-2"></i>My History
                        </button>
                        <button onclick="switchTab('profile')" class="tab-btn px-4 py-2 rounded-xl transition-all text-sm font-medium" data-tab="profile">
                            <i class="fas fa-user mr-2"></i>Profile
                        </button>
                    </nav>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="networkInfo" class="hidden md:flex items-center space-x-2 px-3 py-2 bg-black/5 rounded-xl border border-black/10">
                        <div class="w-2 h-2 bg-black rounded-full pulse-dot"></div>
                        <span class="text-sm font-medium">Base Sepolia</span>
                    </div>
                    <div class="relative">
                        <button id="connectWallet" onclick="handleWalletButton()" class="primary-button px-6 py-3 rounded-xl text-white font-semibold text-sm">
                            Connect Wallet
                        </button>
                        <!-- Wallet Dropdown Menu -->
                        <div id="walletDropdown" class="hidden absolute right-0 mt-2 w-64 wallet-dropdown rounded-2xl">
                            <div class="p-6">
                                <div class="text-sm text-gray-500 mb-1">Connected Wallet</div>
                                <div id="fullAddress" class="font-mono text-xs text-black mb-4 break-all"></div>
                                <div class="text-sm text-gray-500 mb-1">Balance</div>
                                <div id="walletBalance" class="text-2xl font-bold text-black mb-6">0.0000 ETH</div>
                                <div class="space-y-2">
                                    <button onclick="copyAddress()" class="w-full bg-black/5 hover:bg-black/10 text-black py-3 rounded-xl font-medium transition-all">
                                        <i class="fas fa-copy mr-2"></i>Copy Address
                                    </button>
                                    <button onclick="viewOnExplorer()" class="w-full bg-black/5 hover:bg-black/10 text-black py-3 rounded-xl font-medium transition-all">
                                        <i class="fas fa-external-link-alt mr-2"></i>View on Explorer
                                    </button>
                                    <button onclick="disconnectWallet()" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-600 py-3 rounded-xl font-medium transition-all">
                                        <i class="fas fa-sign-out-alt mr-2"></i>Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-12">
            <div class="stats-card rounded-2xl p-6 hover-lift">
                <div class="text-sm text-gray-500 mb-2">Total Donated</div>
                <div class="text-3xl font-black text-black" id="totalDonated">0 ETH</div>
            </div>
            <div class="stats-card rounded-2xl p-6 hover-lift">
                <div class="text-sm text-gray-500 mb-2">Active Pools</div>
                <div class="text-3xl font-black text-black" id="activePools">0</div>
            </div>
            <div class="stats-card rounded-2xl p-6 hover-lift">
                <div class="text-sm text-gray-500 mb-2">Total Donors</div>
                <div class="text-3xl font-black text-black" id="totalDonors">0</div>
            </div>
            <div class="stats-card rounded-2xl p-6 hover-lift">
                <div class="text-sm text-gray-500 mb-2">Your Points</div>
                <div class="text-3xl font-black text-black" id="userPoints">0</div>
                <div class="text-sm text-gray-500" id="userRank"></div>
            </div>
            <div class="token-highlight rounded-2xl p-6 hover-lift">
                <div class="text-sm text-gray-300 mb-2">Tokens Earned</div>
                <div class="text-3xl font-black text-white" id="userTokens">0 $GIVE</div>
                <div class="text-sm text-gray-300">Unclaimed</div>
            </div>
        </div>

        <!-- Donate Tab -->
        <div id="donateTab" class="tab-content">
            <!-- Donation Type Selector -->
            <div class="flex justify-center mb-12">
                <div class="glass-card rounded-2xl p-2">
                    <button onclick="switchDonationType('pools')" id="poolsTypeBtn" class="donation-type-btn px-8 py-4 rounded-xl transition-all font-medium">
                        <i class="fas fa-swimming-pool mr-2"></i>Global Pools
                    </button>
                    <button onclick="switchDonationType('social')" id="socialTypeBtn" class="donation-type-btn px-8 py-4 rounded-xl transition-all font-medium">
                        <i class="fas fa-user-friends mr-2"></i>Direct P2P
                    </button>
                    <button onclick="switchDonationType('legacy')" id="legacyTypeBtn" class="donation-type-btn px-8 py-4 rounded-xl transition-all font-medium">
                        <i class="fas fa-heart mr-2"></i>Verified Recipients
                    </button>
                </div>
            </div>

            <!-- Global Pools Section -->
            <div id="poolsSection" class="donation-section">
                <div class="text-center mb-12">
                    <h2 class="text-5xl font-black mb-6 gradient-text hero-text">Global Donation Pools</h2>
                    <p class="text-xl text-gray-600 max-w-4xl mx-auto subtitle-text">
                        Contribute to global causes and earn $GIVE tokens. No verification needed - just donate and make an impact worldwide.
                    </p>
                </div>
                <div id="poolsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Loading state -->
                    <div class="col-span-full flex justify-center py-12">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Social P2P Section -->
            <div id="socialSection" class="donation-section hidden">
                <div class="text-center mb-12">
                    <h2 class="text-5xl font-black mb-6 gradient-text hero-text">Direct P2P Donations</h2>
                    <p class="text-xl text-gray-600 max-w-4xl mx-auto subtitle-text">
                        Send donations directly to other users. Perfect for Farcaster communities and creator support.
                    </p>
                </div>
                
                <!-- P2P Donation Form -->
                <div class="max-w-lg mx-auto mb-12">
                    <div class="glass-card rounded-3xl p-8">
                        <h3 class="text-2xl font-bold mb-6 text-center">Send Direct Donation</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Recipient Address or @username</label>
                                <input type="text" id="p2pRecipient" placeholder="0x... or @username" 
                                       class="form-input w-full rounded-xl px-4 py-4 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Amount (ETH)</label>
                                <input type="number" id="p2pAmount" step="0.001" min="0.001" placeholder="0.01"
                                       class="form-input w-full rounded-xl px-4 py-4 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Message (optional)</label>
                                <input type="text" id="p2pMessage" placeholder="Thanks for being awesome!" maxlength="280"
                                       class="form-input w-full rounded-xl px-4 py-4 text-sm">
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="p2pPublic" checked class="rounded">
                                <label for="p2pPublic" class="text-sm text-gray-600">Make donation public (earn social bonus)</label>
                            </div>
                            <button onclick="processP2PDonation()" class="primary-button w-full py-4 rounded-xl text-white font-bold">
                                <span id="p2pDonateButtonText">Send Donation</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Popular Recipients -->
                <div class="max-w-5xl mx-auto">
                    <h3 class="text-2xl font-bold mb-8 text-center">💫 Popular Recipients</h3>
                    <div id="popularRecipients" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Popular recipients will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Legacy Recipients Section -->
            <div id="legacySection" class="donation-section hidden">
                <div class="text-center mb-12">
                    <h2 class="text-5xl font-black mb-6 gradient-text hero-text">Verified Recipients</h2>
                    <p class="text-xl text-gray-600 max-w-4xl mx-auto subtitle-text">
                        Support individuals who have been verified and need immediate help.
                    </p>
                </div>
                <div id="recipientsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Recipients will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Social Feed Tab -->
        <div id="socialTab" class="tab-content hidden">
            <div class="text-center mb-12">
                <h2 class="text-5xl font-black mb-6 gradient-text hero-text">Social Donation Feed</h2>
                <p class="text-xl text-gray-600 max-w-4xl mx-auto subtitle-text">
                    See the latest public donations and join the community of givers.
                </p>
            </div>
            
            <div class="max-w-3xl mx-auto">
                <div id="socialFeed" class="space-y-6">
                    <!-- Loading state -->
                    <div class="flex justify-center py-12">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                
                <!-- Load More Button -->
                <div id="loadMoreSocialContainer" class="text-center mt-8 hidden">
                    <button onclick="loadMoreSocialFeed()" class="secondary-button px-8 py-3 rounded-xl font-medium transition-all hover-lift">
                        Load More
                    </button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboardTab" class="tab-content hidden">
            <div class="text-center mb-12">
                <h2 class="text-5xl font-black mb-6 gradient-text hero-text">Top Donors Leaderboard</h2>
                <p class="text-xl text-gray-600 max-w-4xl mx-auto subtitle-text">
                    Celebrate the most generous members of our community.
                </p>
            </div>
            
            <!-- User Position Card (if not in top 10) -->
            <div id="userPositionCard" class="hidden mb-8">
                <div class="glass-card max-w-3xl mx-auto rounded-3xl">
                    <div class="p-6">
                        <div class="text-center text-sm text-gray-500 mb-3">Your Position</div>
                        <div id="userPositionInfo" class="flex items-center justify-between">
                            <!-- User position will be shown here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card max-w-5xl mx-auto rounded-3xl">
                <div class="p-8">
                    <div id="leaderboardList" class="space-y-4">
                        <!-- Loading state -->
                        <div class="flex justify-center py-12">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Donations Tab -->
        <div id="my-donationsTab" class="tab-content hidden">
            <div class="text-center mb-12">
                <h2 class="text-5xl font-black mb-6 gradient-text hero-text">My Donation History</h2>
                <p class="text-xl text-gray-600 max-w-4xl mx-auto subtitle-text">
                    Track your giving journey and impact on the world.
                </p>
            </div>
            
            <!-- User Stats -->
            <div id="userStatsCards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                <div class="stats-card rounded-2xl p-6 hover-lift">
                    <div class="text-3xl font-black text-black mb-2" id="userTotalDonated">0 ETH</div>
                    <div class="text-sm text-gray-500">Total Donated</div>
                </div>
                <div class="stats-card rounded-2xl p-6 hover-lift">
                    <div class="text-3xl font-black text-black mb-2" id="userDonationCount">0</div>
                    <div class="text-sm text-gray-500">Total Donations</div>
                </div>
                <div class="stats-card rounded-2xl p-6 hover-lift">
                    <div class="text-3xl font-black text-black mb-2" id="userTotalPoints">0</div>
                    <div class="text-sm text-gray-500">Points Earned</div>
                </div>
                <div class="token-highlight rounded-2xl p-6 hover-lift">
                    <div class="text-3xl font-black text-white mb-2" id="userCurrentRank">#--</div>
                    <div class="text-sm text-gray-300">Current Rank</div>
                </div>
            </div>

            <!-- Donation History -->
            <div id="donationHistory" class="space-y-6">
                <div class="text-center py-12 text-gray-500">
                    Connect wallet to view your donation history
                </div>
            </div>

            <!-- Load More Button -->
            <div id="loadMoreContainer" class="text-center mt-8 hidden">
                <button onclick="loadMoreDonations()" class="secondary-button px-8 py-3 rounded-xl font-medium transition-all hover-lift">
                    Load More
                </button>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content hidden">
            <div class="max-w-3xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-5xl font-black mb-6 gradient-text hero-text">Your Profile</h2>
                    <p class="text-xl text-gray-600 max-w-2xl mx-auto subtitle-text">
                        Customize your giving profile and manage your preferences.
                    </p>
                </div>
                
                <!-- Profile Form -->
                <div class="glass-card rounded-3xl">
                    <div class="p-8">
                        <div class="space-y-8">
                            <!-- Basic Info -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                                    <input type="text" id="profileDisplayName" placeholder="Your name" 
                                           class="form-input w-full rounded-xl px-4 py-4 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Farcaster Username</label>
                                    <input type="text" id="profileFarcaster" placeholder="@username" 
                                           class="form-input w-full rounded-xl px-4 py-4 text-sm">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                                <textarea id="profileBio" rows="4" placeholder="Tell us about yourself..." maxlength="280"
                                          class="form-input w-full rounded-xl px-4 py-4 text-sm resize-none"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Donation Message</label>
                                <input type="text" id="profileDonationMessage" placeholder="Thanks for your support! 💙" maxlength="100"
                                       class="form-input w-full rounded-xl px-4 py-4 text-sm">
                                <div class="text-xs text-gray-500 mt-2">This message shows when people donate to you</div>
                            </div>

                            <!-- Privacy Settings -->
                            <div class="border-t border-gray-200 pt-8">
                                <h3 class="text-xl font-bold mb-6">Privacy Settings</h3>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-4 bg-black/5 rounded-xl">
                                        <div>
                                            <div class="font-medium text-black">Public Profile</div>
                                            <div class="text-sm text-gray-600">Show your profile on leaderboards</div>
                                        </div>
                                        <input type="checkbox" id="profilePublic" class="rounded">
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-black/5 rounded-xl">
                                        <div>
                                            <div class="font-medium text-black">Accept Donations</div>
                                            <div class="text-sm text-gray-600">Allow others to send you donations</div>
                                        </div>
                                        <input type="checkbox" id="profileAcceptDonations" class="rounded">
                                    </div>
                                </div>
                            </div>

                            <!-- Token Rewards Section -->
                            <div class="border-t border-gray-200 pt-8">
                                <h3 class="text-xl font-bold mb-6">🪙 Token Rewards</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div class="stats-card rounded-xl p-6">
                                        <div class="text-3xl font-black text-black" id="profileTokensEarned">0 $GIVE</div>
                                        <div class="text-sm text-gray-500">Total Earned</div>
                                    </div>
                                    <div class="token-highlight rounded-xl p-6">
                                        <div class="text-3xl font-black text-white" id="profileTokensPending">0 $GIVE</div>
                                        <div class="text-sm text-gray-300">Pending Claim</div>
                                    </div>
                                </div>
                                <button onclick="checkAirdropEligibility()" class="primary-button w-full py-4 rounded-xl text-white font-bold">
                                    Check Airdrop Eligibility
                                </button>
                            </div>

                            <button onclick="updateProfile()" class="primary-button w-full py-4 rounded-xl text-white font-bold">
                                <span id="updateProfileButtonText">Update Profile</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Pool Donation Modal -->
    <div id="poolDonationModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-6">
        <div class="modal-content rounded-3xl max-w-lg w-full p-8">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-3xl font-bold">Donate to Pool</h3>
                <button onclick="closePoolDonationModal()" class="text-gray-400 hover:text-black transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="selectedPool" class="mb-8">
                <!-- Selected pool info will be shown here -->
            </div>
            
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-2">Donation Amount (ETH)</label>
                <input type="number" id="poolDonationAmount" step="0.001" min="0.001" placeholder="0.01" 
                       class="form-input w-full rounded-xl px-4 py-4 text-sm">
                <div class="mt-3 text-sm text-gray-600">
                    Minimum: 0.001 ETH • Points: <span id="poolEstimatedPoints" class="font-bold text-black">0</span> • Tokens: <span id="poolEstimatedTokens" class="font-bold text-black">0 $GIVE</span>
                </div>
            </div>
            
            <button onclick="processPoolDonation()" class="primary-button w-full py-4 rounded-xl text-white font-bold">
                <span id="poolDonateButtonText">Donate Now</span>
            </button>
        </div>
    </div>

    <!-- Legacy Donation Modal -->
    <div id="donationModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-6">
        <div class="modal-content rounded-3xl max-w-lg w-full p-8">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-3xl font-bold">Make a Donation</h3>
                <button onclick="closeDonationModal()" class="text-gray-400 hover:text-black transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="selectedRecipient" class="mb-8">
                <!-- Selected recipient info will be shown here -->
            </div>
            
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-2">Donation Amount (ETH)</label>
                <input type="number" id="donationAmount" step="0.001" min="0.001" placeholder="0.01" 
                       class="form-input w-full rounded-xl px-4 py-4 text-sm">
                <div class="mt-3 text-sm text-gray-600">
                    Minimum: 0.001 ETH • Points: <span id="estimatedPoints" class="font-bold text-black">0</span>
                </div>
            </div>
            
            <button onclick="processDonation()" class="primary-button w-full py-4 rounded-xl text-white font-bold">
                <span id="donateButtonText">Donate Now</span>
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-6">
        <div class="modal-content rounded-3xl max-w-lg w-full p-8 text-center">
            <div class="w-20 h-20 bg-black/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-3xl text-black"></i>
            </div>
            <h3 class="text-3xl font-bold mb-4">Donation Successful!</h3>
            <p class="text-gray-600 mb-8 text-lg">Thank you for your generosity. Your donation has been recorded on the blockchain.</p>
            <div class="bg-black/5 rounded-2xl p-6 mb-8">
                <div class="text-sm text-gray-500 mb-2">Transaction Hash</div>
                <div id="txHash" class="font-mono text-xs break-all text-black font-medium"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="stats-card rounded-2xl p-4">
                    <div class="text-2xl font-black text-black">+<span id="pointsEarned">0</span></div>
                    <div class="text-sm text-gray-500">Points Earned</div>
                </div>
                <div class="token-highlight rounded-2xl p-4">
                    <div class="text-2xl font-black text-white">+<span id="tokensEarned">0</span></div>
                    <div class="text-sm text-gray-300">$GIVE Tokens</div>
                </div>
            </div>
            <button onclick="closeSuccessModal()" class="primary-button py-4 px-8 rounded-xl text-white font-bold">
                Continue Giving
            </button>
        </div>
    </div>

    <script>
        // Web3 and contract setup
        let web3;
        let userAccount;
        let selectedRecipientId;
        let selectedPoolId;
        let currentPage = 1;
        let currentSocialPage = 1;
        let hasMoreDonations = false;
        let hasMoreSocialFeed = false;
        let currentDonationType = 'pools';
        
        const BASE_SEPOLIA_CHAIN_ID = '0x14A34'; // 84532 in decimal
        const CONTRACT_ADDRESS = '{{ contract_address }}';

        // Initialize
        window.addEventListener('load', async () => {
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed!');
                await checkWalletConnection();
            } else {
                console.log('MetaMask is not installed');
                updateConnectButton('Install MetaMask', false);
            }
            
            await loadStats();
            await loadPools();
            switchTab('donate');
            
            // Update donation amount input listeners
            document.getElementById('donationAmount').addEventListener('input', updateEstimatedPoints);
            document.getElementById('poolDonationAmount').addEventListener('input', updatePoolEstimatedRewards);
            document.getElementById('p2pAmount').addEventListener('input', updateP2PEstimatedRewards);

            // Initialize animations
            initializeAnimations();
        });

        // Initialize scroll animations
        function initializeAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        if (entry.target.classList.contains('fade-in-up')) {
                            entry.target.style.animationPlayState = 'running';
                        }
                    }
                });
            }, observerOptions);

            // Observe elements for animations
            document.querySelectorAll('.fade-in-up, .slide-in-left, .slide-in-right').forEach(el => {
                el.style.animationPlayState = 'paused';
                observer.observe(el);
            });
        }

        // Handle wallet button click (connect or show dropdown)
        async function handleWalletButton() {
            if (typeof window.ethereum === 'undefined') {
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            if (userAccount) {
                // Toggle dropdown
                const dropdown = document.getElementById('walletDropdown');
                dropdown.classList.toggle('hidden');
                
                // Update balance when showing dropdown
                if (!dropdown.classList.contains('hidden')) {
                    await updateWalletBalance();
                }
            } else {
                // Connect
                await connectWallet();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const walletBtn = document.getElementById('connectWallet');
            const dropdown = document.getElementById('walletDropdown');
            
            if (!walletBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Update wallet balance
        async function updateWalletBalance() {
            if (!userAccount || !web3) return;
            
            try {
                const balanceWei = await web3.eth.getBalance(userAccount);
                const balanceEth = web3.utils.fromWei(balanceWei, 'ether');
                document.getElementById('walletBalance').textContent = `${parseFloat(balanceEth).toFixed(4)} ETH`;
            } catch (error) {
                console.error('Error fetching balance:', error);
            }
        }

        // Copy address to clipboard
        function copyAddress() {
            if (userAccount) {
                navigator.clipboard.writeText(userAccount).then(() => {
                    alert('Address copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }

        // View on block explorer
        function viewOnExplorer() {
            if (userAccount) {
                window.open(`https://sepolia.basescan.org/address/${userAccount}`, '_blank');
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            userAccount = null;
            web3 = null;
            updateConnectButton('Connect Wallet', false);
            document.getElementById('networkInfo').classList.add('hidden');
            document.getElementById('walletDropdown').classList.add('hidden');
            document.getElementById('userPoints').textContent = '0';
            document.getElementById('userTokens').textContent = '0 $GIVE';
            document.getElementById('userRank').textContent = '';
            
            // Clear user-specific data
            resetUserData();
            
            console.log('Wallet disconnected');
        }

        function resetUserData() {
            // Reset donation history
            const donationHistory = document.getElementById('donationHistory');
            donationHistory.innerHTML = '<div class="text-center py-12 text-gray-500">Connect wallet to view your donation history</div>';
            
            // Reset user stats
            document.getElementById('userTotalDonated').textContent = '0 ETH';
            document.getElementById('userDonationCount').textContent = '0';
            document.getElementById('userTotalPoints').textContent = '0';
            document.getElementById('userCurrentRank').textContent = '#--';
            
            // Hide user position card
            document.getElementById('userPositionCard').classList.add('hidden');

            // Reset profile form
            resetProfileForm();
        }

        // Update connect button UI
        function updateConnectButton(text, isConnected) {
            const connectBtn = document.getElementById('connectWallet');
            connectBtn.textContent = text;
            
            if (isConnected) {
                connectBtn.classList.remove('primary-button');
                connectBtn.classList.add('secondary-button');
            } else {
                connectBtn.classList.add('primary-button');
                connectBtn.classList.remove('secondary-button');
            }
        }

        // Wallet connection
        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                
                try {
                    const accounts = await web3.eth.getAccounts();
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        await checkAndSwitchNetwork();
                        updateWalletUI();
                        await loadUserStats();
                        await loadUserProfile();
                    }
                } catch (error) {
                    console.error('Error checking wallet connection:', error);
                }
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask to use Umanity!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                if (accounts.length === 0) {
                    alert('No accounts found. Please check your MetaMask.');
                    return;
                }
                
                userAccount = accounts[0];
                web3 = new Web3(window.ethereum);
                
                // Check and switch to Base Sepolia
                await checkAndSwitchNetwork();
                
                // Update UI
                updateWalletUI();
                
                // Load user-specific data
                await loadUserStats();
                await loadUserProfile();
                
                console.log('Connected to wallet:', userAccount);
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                if (error.code === 4001) {
                    // User rejected the request
                    alert('Connection cancelled. Please approve the connection in MetaMask.');
                } else {
                    alert('Failed to connect wallet. Please try again.');
                }
            }
        }

        async function checkAndSwitchNetwork() {
            try {
                const chainId = await web3.eth.getChainId();
                const currentChainId = '0x' + chainId.toString(16);
                
                console.log('Current chain ID:', currentChainId);
                console.log('Expected chain ID:', BASE_SEPOLIA_CHAIN_ID);
                
                if (currentChainId !== BASE_SEPOLIA_CHAIN_ID) {
                    console.log('Wrong network, switching to Base Sepolia...');
                    await switchToBaseSepolia();
                } else {
                    console.log('Already on Base Sepolia');
                }
            } catch (error) {
                console.error('Error checking network:', error);
            }
        }

        async function switchToBaseSepolia() {
            try {
                // Try to switch to Base Sepolia
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
                });
                console.log('Switched to Base Sepolia');
            } catch (switchError) {
                // This error code indicates that the chain has not been added to MetaMask
                if (switchError.code === 4902) {
                    console.log('Base Sepolia not found, adding network...');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_SEPOLIA_CHAIN_ID,
                                chainName: 'Base Sepolia',
                                nativeCurrency: {
                                    name: 'Ethereum',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                rpcUrls: ['https://sepolia.base.org'],
                                blockExplorerUrls: ['https://sepolia.basescan.org']
                            }]
                        });
                        console.log('Base Sepolia network added successfully');
                    } catch (addError) {
                        console.error('Error adding Base Sepolia network:', addError);
                        alert('Failed to add Base Sepolia network. Please add it manually in MetaMask.');
                    }
                } else {
                    console.error('Error switching network:', switchError);
                    alert('Failed to switch network. Please switch to Base Sepolia manually in MetaMask.');
                }
            }
        }

        function updateWalletUI() {
            if (userAccount) {
                const shortAddress = `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
                updateConnectButton(shortAddress, true);
                document.getElementById('networkInfo').classList.remove('hidden');
                
                // Update dropdown info
                document.getElementById('fullAddress').textContent = userAccount;
            }
        }

        // Tab switching
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName, 'User account:', userAccount);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            // Add active class to button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('tab-active');
            }
            
            // Load tab-specific data
            if (tabName === 'leaderboard') {
                console.log('Loading leaderboard...');
                loadLeaderboard();
            } else if (tabName === 'my-donations') {
                console.log('Loading my donations, user:', userAccount);
                if (userAccount) {
                    loadUserDonations();
                } else {
                    console.log('No user account, showing connect wallet message');
                    const historyDiv = document.getElementById('donationHistory');
                    historyDiv.innerHTML = '<div class="text-center py-12 text-gray-500">Connect wallet to view your donation history</div>';
                }
            } else if (tabName === 'social') {
                loadSocialFeed();
            } else if (tabName === 'profile') {
                if (userAccount) {
                    loadUserProfile();
                }
            }
        }

        // Donation type switching
        function switchDonationType(type) {
            currentDonationType = type;
            
            // Hide all sections
            document.querySelectorAll('.donation-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.donation-type-btn').forEach(btn => {
                btn.classList.remove('donation-type-active');
            });
            
            // Show selected section
            if (type === 'pools') {
                document.getElementById('poolsSection').classList.remove('hidden');
                document.getElementById('poolsTypeBtn').classList.add('donation-type-active');
                loadPools();
            } else if (type === 'social') {
                document.getElementById('socialSection').classList.remove('hidden');
                document.getElementById('socialTypeBtn').classList.add('donation-type-active');
                loadPopularRecipients();
            } else if (type === 'legacy') {
                document.getElementById('legacySection').classList.remove('hidden');
                document.getElementById('legacyTypeBtn').classList.add('donation-type-active');
                loadRecipients();
            }
        }

        // Load donation pools
        async function loadPools() {
            try {
                const response = await fetch('/api/pools/');
                const data = await response.json();
                
                const grid = document.getElementById('poolsGrid');
                grid.innerHTML = '';
                
                if (data.pools.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No active pools yet. Check back soon!</div>';
                    return;
                }
                
                data.pools.forEach(pool => {
                    const card = document.createElement('div');
                    card.className = 'pool-card rounded-3xl p-8 text-center hover-lift';
                    card.innerHTML = `
                        <div class="text-6xl mb-6 floating">${pool.emoji}</div>
                        <h3 class="text-2xl font-bold mb-4 text-black">${pool.name}</h3>
                        <p class="text-gray-600 text-sm mb-6 leading-relaxed">${pool.description}</p>
                        
                        <div class="mb-6">
                            <div class="text-3xl font-black text-black mb-2">${parseFloat(pool.total_raised).toFixed(4)} ETH</div>
                            <div class="text-sm text-gray-500">${pool.donor_count} donors</div>
                        </div>
                        
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-6 overflow-hidden">
                            <div class="progress-bar h-3 rounded-full" style="width: ${pool.progress_percentage}%"></div>
                        </div>
                        
                        <button onclick="openPoolDonationModal(${pool.id})" 
                                class="primary-button w-full py-3 rounded-xl text-white font-bold transition-all">
                            Donate to Pool
                        </button>
                    `;
                    grid.appendChild(card);
                });
                
            } catch (error) {
                console.error('Error loading pools:', error);
                const grid = document.getElementById('poolsGrid');
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-red-500">Error loading pools. Please try again.</div>';
            }
        }

        // Load popular recipients for P2P
        async function loadPopularRecipients() {
            try {
                const response = await fetch('/api/user-profile/?popular=true');
                const data = await response.json();
                
                const grid = document.getElementById('popularRecipients');
                grid.innerHTML = '';
                
                // Mock popular recipients for now
                const mockRecipients = [
                    { address: '0x1234...5678', display_name: '@alice', total_received: '0.5', avatar_url: '' },
                    { address: '0x2345...6789', display_name: '@bob', total_received: '0.3', avatar_url: '' },
                    { address: '0x3456...7890', display_name: '@charlie', total_received: '0.2', avatar_url: '' }
                ];
                
                mockRecipients.forEach(recipient => {
                    const card = document.createElement('div');
                    card.className = 'social-card rounded-2xl p-6 cursor-pointer hover-lift';
                    card.onclick = () => fillP2PForm(recipient.address, recipient.display_name);
                    card.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-black to-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-lg font-bold text-white">${recipient.display_name.charAt(1).toUpperCase()}</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-black">${recipient.display_name}</div>
                                <div class="text-sm text-gray-500">${recipient.total_received} ETH received</div>
                            </div>
                            <button class="primary-button px-4 py-2 rounded-xl text-white text-sm font-medium">
                                Donate
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
            } catch (error) {
                console.error('Error loading popular recipients:', error);
            }
        }

        function fillP2PForm(address, displayName) {
            document.getElementById('p2pRecipient').value = displayName || address;
        }

        // Load legacy recipients
        async function loadRecipients() {
            try {
                const response = await fetch('/api/recipients/');
                const data = await response.json();
                
                const grid = document.getElementById('recipientsGrid');
                grid.innerHTML = '';
                
                if (data.recipients.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No verified recipients yet. Check back soon!</div>';
                    return;
                }
                
                // Only show legacy recipients (not pools)
                const legacyRecipients = data.recipients.filter(r => !r.is_pool);
                
                if (legacyRecipients.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No verified recipients yet. Check back soon!</div>';
                    return;
                }
                
                legacyRecipients.forEach(recipient => {
                    const progress = Math.min((parseFloat(recipient.raised_amount) / parseFloat(recipient.goal_amount)) * 100, 100);
                    
                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-3xl hover-lift';
                    card.innerHTML = `
                        <div class="p-8 h-full flex flex-col">
                            <div class="flex items-center justify-between mb-6">
                                <span class="px-4 py-2 bg-black/10 text-black rounded-full text-sm font-medium">
                                    ${getCategoryIcon(recipient.category)} ${recipient.category}
                                </span>
                                <div class="text-right">
                                    <div class="text-xs text-gray-500">Urgency</div>
                                    <div class="text-black font-bold">${'★'.repeat(recipient.urgency_level || 3)}</div>
                                </div>
                            </div>
                            
                            <h3 class="text-2xl font-bold mb-3 text-black">${recipient.name}</h3>
                            ${recipient.location ? `<div class="text-sm text-gray-500 mb-3">📍 ${recipient.location}</div>` : ''}
                            <p class="text-gray-600 text-sm mb-6 flex-grow leading-relaxed">${recipient.description.substring(0, 150)}...</p>
                            
                            <div class="mb-6">
                                <div class="flex justify-between text-sm mb-3">
                                    <span class="text-gray-600">Raised: ${parseFloat(recipient.raised_amount).toFixed(4)} ETH</span>
                                    <span class="text-gray-600">Goal: ${parseFloat(recipient.goal_amount).toFixed(4)} ETH</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div class="progress-bar h-3 rounded-full" style="width: ${progress}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-2">${progress.toFixed(1)}% funded</div>
                            </div>
                            
                            <button onclick="openDonationModal(${recipient.id})" 
                                    class="primary-button w-full py-3 rounded-xl text-white font-bold">
                                Donate Now
                            </button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
            } catch (error) {
                console.error('Error loading recipients:', error);
            }
        }

        // Load platform stats
        async function loadStats() {
            try {
                const url = userAccount ? `/api/stats/?user=${userAccount}` : '/api/stats/';
                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('totalDonated').textContent = `${parseFloat(data.total_donated).toFixed(4)} ETH`;
                document.getElementById('activePools').textContent = data.active_pools || '0';
                document.getElementById('totalDonors').textContent = data.total_donors;
                document.getElementById('userPoints').textContent = data.user_points || '0';
                
                // Show user rank if available
                if (data.user_stats && data.user_stats.rank) {
                    document.getElementById('userRank').textContent = `Rank #${data.user_stats.rank}`;
                }

                // Show user tokens if available
                if (data.user_stats && data.user_stats.tokens_earned) {
                    document.getElementById('userTokens').textContent = `${parseFloat(data.user_stats.tokens_earned).toFixed(2)} $GIVE`;
                }
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load user stats
        async function loadUserStats() {
            if (!userAccount) return;
            
            try {
                const response = await fetch(`/api/stats/?user=${userAccount}`);
                const data = await response.json();
                
                document.getElementById('userPoints').textContent = data.user_points || '0';
                
                if (data.user_stats && data.user_stats.rank) {
                    document.getElementById('userRank').textContent = `Rank #${data.user_stats.rank}`;
                }

                if (data.user_stats && data.user_stats.tokens_earned) {
                    document.getElementById('userTokens').textContent = `${parseFloat(data.user_stats.tokens_earned).toFixed(2)} $GIVE`;
                }
                
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Load user profile
        async function loadUserProfile() {
            if (!userAccount) return;
            
            try {
                const response = await fetch(`/api/user-profile/?address=${userAccount}`);
                const data = await response.json();
                
                if (data.exists !== false) {
                    // Fill profile form
                    document.getElementById('profileDisplayName').value = data.display_name || '';
                    document.getElementById('profileFarcaster').value = data.farcaster_username || '';
                    document.getElementById('profileBio').value = data.bio || '';
                    document.getElementById('profileDonationMessage').value = data.donation_message || '';
                    document.getElementById('profilePublic').checked = data.is_public !== false;
                    document.getElementById('profileAcceptDonations').checked = data.accepts_donations !== false;
                    
                    // Update token info
                    document.getElementById('profileTokensEarned').textContent = `${parseFloat(data.tokens_earned || 0).toFixed(2)} $GIVE`;
                    
                    // Calculate pending tokens
                    const tokensEarned = parseFloat(data.tokens_earned || 0);
                    const tokensClaimed = parseFloat(data.tokens_claimed || 0);
                    const pending = tokensEarned - tokensClaimed;
                    document.getElementById('profileTokensPending').textContent = `${pending.toFixed(2)} $GIVE`;
                } else {
                    // Set defaults for new user
                    document.getElementById('profilePublic').checked = true;
                    document.getElementById('profileAcceptDonations').checked = true;
                    document.getElementById('profileDonationMessage').value = 'Thanks for your support! 💙';
                }
                
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function resetProfileForm() {
            document.getElementById('profileDisplayName').value = '';
            document.getElementById('profileFarcaster').value = '';
            document.getElementById('profileBio').value = '';
            document.getElementById('profileDonationMessage').value = 'Thanks for your support! 💙';
            document.getElementById('profilePublic').checked = true;
            document.getElementById('profileAcceptDonations').checked = true;
            document.getElementById('profileTokensEarned').textContent = '0 $GIVE';
            document.getElementById('profileTokensPending').textContent = '0 $GIVE';
        }

        // Update user profile
        async function updateProfile() {
            if (!userAccount) {
                alert('Please connect your wallet first!');
                return;
            }

            const updateBtn = document.getElementById('updateProfileButtonText');
            updateBtn.textContent = 'Updating...';

            try {
                const profileData = {
                    wallet_address: userAccount,
                    display_name: document.getElementById('profileDisplayName').value,
                    farcaster_username: document.getElementById('profileFarcaster').value,
                    bio: document.getElementById('profileBio').value,
                    donation_message: document.getElementById('profileDonationMessage').value,
                    is_public_profile: document.getElementById('profilePublic').checked,
                    accepts_donations: document.getElementById('profileAcceptDonations').checked
                };

                const response = await fetch('/api/update-profile/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(profileData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Profile updated successfully!');
                } else {
                    alert('Error updating profile: ' + data.error);
                }

            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Failed to update profile. Please try again.');
            } finally {
                updateBtn.textContent = 'Update Profile';
            }
        }

        // Check airdrop eligibility
        async function checkAirdropEligibility() {
            if (!userAccount) {
                alert('Please connect your wallet first!');
                return;
            }

            try {
                const response = await fetch(`/api/airdrop-eligibility/?address=${userAccount}`);
                const data = await response.json();

                let message = `🪙 Airdrop Eligibility Check\n\n`;
                message += `Eligible: ${data.eligible ? '✅ YES' : '❌ NO'}\n`;
                message += `Total Points: ${data.total_points}\n`;
                message += `Base Tokens: ${data.base_tokens} $GIVE\n`;
                message += `Multiplier: ${data.multiplier}x\n`;
                message += `Final Tokens: ${data.final_tokens} $GIVE\n`;
                message += `Current Rank: #${data.rank || 'N/A'}\n\n`;
                message += `Bonus Reason: ${data.reason}`;

                alert(message);

            } catch (error) {
                console.error('Error checking airdrop eligibility:', error);
                alert('Failed to check eligibility. Please try again.');
            }
        }

        // Load social feed
        async function loadSocialFeed(page = 1) {
            try {
                const response = await fetch(`/api/social-feed/?page=${page}&limit=20`);
                const data = await response.json();
                
                const feed = document.getElementById('socialFeed');
                
                if (page === 1) {
                    feed.innerHTML = '';
                }
                
                if (data.feed.length === 0 && page === 1) {
                    feed.innerHTML = '<div class="text-center py-12 text-gray-500">No public donations yet. Be the first to share your generosity!</div>';
                    return;
                }
                
                data.feed.forEach(donation => {
                    const feedItem = document.createElement('div');
                    feedItem.className = 'social-card rounded-2xl p-6';
                    feedItem.innerHTML = `
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-black to-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-lg font-bold text-white">${donation.donor.display_name ? donation.donor.display_name.charAt(0).toUpperCase() : 'A'}</span>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-bold text-black">${donation.donor.display_name || donation.donor.address.substring(0, 8) + '...'}</span>
                                    <span class="text-gray-600">donated</span>
                                    <span class="font-bold text-black">${parseFloat(donation.amount).toFixed(4)} ETH</span>
                                    <span class="text-gray-600">to</span>
                                    <span class="font-bold text-black">${donation.recipient.display_name || donation.recipient.address.substring(0, 8) + '...'}</span>
                                    ${donation.frame_interaction ? '<span class="bg-black/10 text-black px-3 py-1 rounded-full text-xs font-medium">Frame</span>' : ''}
                                </div>
                                ${donation.message ? `<div class="text-gray-700 text-sm mb-3 italic">"${donation.message}"</div>` : ''}
                                <div class="flex items-center justify-between text-sm text-gray-500">
                                    <span>${donation.time_ago}</span>
                                    <div class="flex items-center space-x-4">
                                        <span class="text-black font-medium">+${donation.points_earned} pts</span>
                                        <a href="https://sepolia.basescan.org/tx/${donation.tx_hash}" target="_blank" class="text-black hover:text-gray-700">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    feed.appendChild(feedItem);
                });
                
                // Handle pagination
                const loadMoreContainer = document.getElementById('loadMoreSocialContainer');
                if (data.pagination && data.pagination.has_next) {
                    loadMoreContainer.classList.remove('hidden');
                    hasMoreSocialFeed = true;
                    currentSocialPage = page;
                } else {
                    loadMoreContainer.classList.add('hidden');
                    hasMoreSocialFeed = false;
                }
                
            } catch (error) {
                console.error('Error loading social feed:', error);
                const feed = document.getElementById('socialFeed');
                feed.innerHTML = '<div class="text-center py-12 text-red-500">Error loading social feed. Please try again.</div>';
            }
        }

        function loadMoreSocialFeed() {
            if (hasMoreSocialFeed) {
                loadSocialFeed(currentSocialPage + 1);
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const url = userAccount ? `/api/leaderboard/?user=${userAccount}` : '/api/leaderboard/';
                const response = await fetch(url);
                const data = await response.json();
                
                const list = document.getElementById('leaderboardList');
                list.innerHTML = '';
                
                if (data.leaderboard.length === 0) {
                    list.innerHTML = '<div class="text-center py-12 text-gray-500">Be the first to donate and claim the top spot!</div>';
                    return;
                }
                
                data.leaderboard.forEach((donor, index) => {
                    const rankColors = ['text-yellow-600', 'text-gray-600', 'text-orange-600', 'text-black'];
                    const rankColor = rankColors[Math.min(index, 3)];
                    
                    const row = document.createElement('div');
                    row.className = `leaderboard-item rounded-2xl p-6 ${donor.is_current_user ? 'user-highlight' : ''}`;
                    row.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-6">
                                <span class="text-3xl font-black ${rankColor}">#${donor.rank}</span>
                                <div class="w-12 h-12 bg-gradient-to-r from-black to-gray-700 rounded-full flex items-center justify-center">
                                    <span class="text-lg font-bold text-white">${donor.display_name ? donor.display_name.charAt(0).toUpperCase() : 'A'}</span>
                                </div>
                                <div>
                                    <div class="font-bold text-lg ${donor.is_current_user ? 'text-white' : 'text-black'}">${donor.display_name || donor.ens_name || (donor.address.substring(0, 6) + '...' + donor.address.substring(38))}</div>
                                    <div class="text-sm ${donor.is_current_user ? 'text-gray-300' : 'text-gray-500'}">${donor.donation_count} donations</div>
                                </div>
                                ${donor.is_current_user ? '<span class="bg-white/20 text-white text-sm px-3 py-1 rounded-full font-medium">You</span>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black ${donor.is_current_user ? 'text-white' : rankColor}">${donor.total_points} pts</div>
                                <div class="text-sm ${donor.is_current_user ? 'text-gray-300' : 'text-gray-500'}">${parseFloat(donor.total_donated).toFixed(4)} ETH</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(row);
                });
                
                // Show user position card if user is not in top 100
                if (userAccount && data.user_position && !data.user_position.is_current_user) {
                    const userPos = data.user_position;
                    const userPositionCard = document.getElementById('userPositionCard');
                    const userPositionInfo = document.getElementById('userPositionInfo');
                    
                    userPositionInfo.innerHTML = `
                        <div class="flex items-center space-x-6">
                            <span class="text-3xl font-black text-black">#${userPos.rank}</span>
                            <div class="w-12 h-12 bg-gradient-to-r from-black to-gray-700 rounded-full flex items-center justify-center">
                                <span class="text-lg font-bold text-white">${userPos.display_name ? userPos.display_name.charAt(0).toUpperCase() : 'Y'}</span>
                            </div>
                            <div>
                                <div class="font-bold text-lg text-black">${userPos.display_name || userPos.ens_name || (userPos.address.substring(0, 6) + '...' + userPos.address.substring(38))}</div>
                                <div class="text-sm text-gray-500">${userPos.donation_count} donations</div>
                            </div>
                            <span class="bg-black text-white text-sm px-3 py-1 rounded-full font-medium">You</span>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-black">${userPos.total_points} pts</div>
                            <div class="text-sm text-gray-500">${parseFloat(userPos.total_donated).toFixed(4)} ETH</div>
                        </div>
                    `;
                    
                    userPositionCard.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Load user donations
        async function loadUserDonations(page = 1) {
            if (!userAccount) {
                resetUserData();
                return;
            }

            try {
                console.log('Loading user donations for:', userAccount, 'page:', page);
                const response = await fetch(`/api/user-donations/?user=${userAccount}&page=${page}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('User donations data:', data);
                
                // Check if we have the expected data structure
                if (!data.user_stats) {
                    console.error('Missing user_stats in response');
                    throw new Error('Invalid response format');
                }
                
                // Update user stats cards
                const stats = data.user_stats;
                document.getElementById('userTotalDonated').textContent = `${parseFloat(stats.total_donated || 0).toFixed(4)} ETH`;
                document.getElementById('userDonationCount').textContent = stats.donation_count || 0;
                document.getElementById('userTotalPoints').textContent = stats.total_points || 0;
                
                // Get user rank
                if (stats.rank) {
                    document.getElementById('userCurrentRank').textContent = `#${stats.rank}`;
                } else {
                    document.getElementById('userCurrentRank').textContent = '#--';
                }
                
                const historyDiv = document.getElementById('donationHistory');
                
                if (page === 1) {
                    // Clear existing donations for first page
                    historyDiv.innerHTML = '';
                }
                
                // Check if we have donations array
                if (!data.donations || !Array.isArray(data.donations)) {
                    console.error('Missing or invalid donations array');
                    historyDiv.innerHTML = '<div class="text-center py-12 text-gray-500">Error loading donation history. Please try again.</div>';
                    return;
                }
                
                if (data.donations.length === 0 && page === 1) {
                    historyDiv.innerHTML = '<div class="text-center py-12 text-gray-500">No donations yet. Make your first donation to appear here!</div>';
                    return;
                }
                
                // Add donations
                data.donations.forEach(donation => {
                    const donationCard = document.createElement('div');
                    donationCard.className = 'glass-card rounded-2xl p-6';
                    
                    let typeIcon = '📍';
                    let typeBadge = '';
                    let recipientInfo = donation.recipient_name || 'Unknown Recipient';
                    
                    if (donation.type === 'pool') {
                        typeIcon = donation.emoji || '🌍';
                        typeBadge = '<span class="bg-black/10 text-black px-3 py-1 rounded-full text-xs font-medium ml-2">Pool</span>';
                    } else if (donation.type === 'social') {
                        typeIcon = '👤';
                        typeBadge = '<span class="bg-black/10 text-black px-3 py-1 rounded-full text-xs font-medium ml-2">P2P</span>';
                        if (donation.frame_interaction) {
                            typeBadge += '<span class="bg-black/10 text-black px-3 py-1 rounded-full text-xs font-medium ml-1">Frame</span>';
                        }
                    } else if (donation.type === 'legacy') {
                        typeIcon = '❤️';
                        typeBadge = '<span class="bg-black/10 text-black px-3 py-1 rounded-full text-xs font-medium ml-2">Legacy</span>';
                    }
                    
                    donationCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <span class="text-3xl mr-4">${typeIcon}</span>
                                <div>
                                    <h4 class="font-bold text-lg text-black">${recipientInfo}</h4>
                                    <div class="flex items-center mt-1">
                                        <span class="px-3 py-1 bg-black/10 text-black rounded-full text-xs font-medium">
                                            ${getCategoryIcon(donation.recipient_category || 'medical')} ${donation.recipient_category || 'donation'}
                                        </span>
                                        ${typeBadge}
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-black">${parseFloat(donation.amount || 0).toFixed(4)} ETH</div>
                                <div class="text-sm text-black font-medium">+${donation.points_earned || 0} pts</div>
                            </div>
                        </div>
                        ${donation.message ? `<div class="text-sm text-gray-700 mb-4 italic bg-black/5 p-3 rounded-xl">"${donation.message}"</div>` : ''}
                        <div class="flex justify-between items-center text-sm text-gray-500">
                            <span>${donation.time_ago || 'Unknown time'}</span>
                            ${donation.tx_hash ? `<a href="https://sepolia.basescan.org/tx/${donation.tx_hash}" target="_blank" class="text-black hover:text-gray-700 font-medium">
                                View Transaction <i class="fas fa-external-link-alt ml-1"></i>
                            </a>` : '<span class="text-gray-500">No transaction hash</span>'}
                        </div>
                    `;
                    historyDiv.appendChild(donationCard);
                });
                
                // Handle pagination
                const loadMoreContainer = document.getElementById('loadMoreContainer');
                if (data.pagination && data.pagination.has_next) {
                    loadMoreContainer.classList.remove('hidden');
                    hasMoreDonations = true;
                    currentPage = page;
                } else {
                    loadMoreContainer.classList.add('hidden');
                    hasMoreDonations = false;
                }
                
            } catch (error) {
                console.error('Error loading user donations:', error);
                const historyDiv = document.getElementById('donationHistory');
                
                if (error.message.includes('404') || error.message.includes('HTTP error! status: 404')) {
                    historyDiv.innerHTML = '<div class="text-center py-12 text-gray-500">API endpoint not found. Please check your backend configuration.</div>';
                } else if (error.message.includes('Failed to fetch')) {
                    historyDiv.innerHTML = '<div class="text-center py-12 text-gray-500">Cannot connect to server. Please check your backend is running.</div>';
                } else {
                    historyDiv.innerHTML = `<div class="text-center py-12 text-gray-500">Error loading donations: ${error.message}</div>`;
                }
                
                // Reset stats to default values on error
                document.getElementById('userTotalDonated').textContent = '0 ETH';
                document.getElementById('userDonationCount').textContent = '0';
                document.getElementById('userTotalPoints').textContent = '0';
                document.getElementById('userCurrentRank').textContent = '#--';
            }
        }

        function loadMoreDonations() {
            if (hasMoreDonations) {
                loadUserDonations(currentPage + 1);
            }
        }

        // Pool donation modal
        function openPoolDonationModal(poolId) {
            if (!userAccount) {
                alert('Please connect your wallet first!');
                return;
            }
            
            selectedPoolId = poolId;
            document.getElementById('poolDonationModal').classList.remove('hidden');
            
            // Load pool details
            fetch('/api/pools/')
                .then(res => res.json())
                .then(data => {
                    const pool = data.pools.find(p => p.id === poolId);
                    if (pool) {
                        document.getElementById('selectedPool').innerHTML = `
                            <div class="glass-card rounded-2xl p-6 text-center">
                                <div class="text-5xl mb-4">${pool.emoji}</div>
                                <h4 class="font-bold text-2xl mb-3 text-black">${pool.name}</h4>
                                <p class="text-sm text-gray-600 mb-4">${pool.description}</p>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="bg-black/5 rounded-xl p-3">
                                        <div class="text-gray-500 text-xs">Total Raised</div>
                                        <div class="font-bold text-lg text-black">${parseFloat(pool.total_raised).toFixed(4)} ETH</div>
                                    </div>
                                    <div class="bg-black/5 rounded-xl p-3">
                                        <div class="text-gray-500 text-xs">Donors</div>
                                        <div class="font-bold text-lg text-black">${pool.donor_count}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
        }

        function closePoolDonationModal() {
            document.getElementById('poolDonationModal').classList.add('hidden');
            document.getElementById('poolDonationAmount').value = '';
            selectedPoolId = null;
        }

        function updatePoolEstimatedRewards() {
            const amount = parseFloat(document.getElementById('poolDonationAmount').value) || 0;
            const points = Math.max(Math.floor(amount * 1000), 0);
            const tokens = Math.max((amount * 100), 0); // 100 tokens per ETH base rate
            document.getElementById('poolEstimatedPoints').textContent = points;
            document.getElementById('poolEstimatedTokens').textContent = tokens.toFixed(1);
        }

        // Process pool donation
        async function processPoolDonation() {
            const amount = document.getElementById('poolDonationAmount').value;
            
            if (!amount || parseFloat(amount) < 0.001) {
                alert('Minimum donation is 0.001 ETH');
                return;
            }
            
            if (!selectedPoolId) return;
            
            const donateBtn = document.getElementById('poolDonateButtonText');
            donateBtn.textContent = 'Processing...';
            
            try {
                // Check user balance first
                const balanceWei = await web3.eth.getBalance(userAccount);
                const balanceEth = parseFloat(web3.utils.fromWei(balanceWei, 'ether'));
                const donationAmount = parseFloat(amount);
                
                // Account for gas fees (roughly 0.0001 ETH for simple transfer)
                if (balanceEth < donationAmount + 0.0001) {
                    alert(`Insufficient balance. You have ${balanceEth.toFixed(4)} ETH but need at least ${(donationAmount + 0.0001).toFixed(4)} ETH (including gas fees).`);
                    donateBtn.textContent = 'Donate Now';
                    return;
                }
                
                // Get pool wallet
                const response = await fetch('/api/pools/');
                const data = await response.json();
                const pool = data.pools.find(p => p.id === selectedPoolId);
                
                if (!pool) {
                    alert('Pool not found');
                    donateBtn.textContent = 'Donate Now';
                    return;
                }
                
                // Send transaction directly to pool wallet
                const amountWei = web3.utils.toWei(amount, 'ether');
                
                console.log('Sending pool donation:', {
                    from: userAccount,
                    to: pool.wallet_address,
                    value: amountWei
                });
                
                const tx = await web3.eth.sendTransaction({
                    from: userAccount,
                    to: pool.wallet_address,
                    value: amountWei,
                    gas: 21000, // Standard gas limit for ETH transfer
                });
                
                console.log('Pool donation successful:', tx);
                
                // Record donation in backend
                await fetch('/api/donate-to-pool/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        donor_address: userAccount,
                        pool_id: selectedPoolId,
                        amount: amount,
                        tx_hash: tx.transactionHash,
                        block_number: tx.blockNumber,
                    }),
                });
                
                // Show success
                document.getElementById('txHash').textContent = tx.transactionHash;
                document.getElementById('pointsEarned').textContent = Math.floor(parseFloat(amount) * 1000);
                document.getElementById('tokensEarned').textContent = (parseFloat(amount) * 100).toFixed(1);
                
                closePoolDonationModal();
                document.getElementById('successModal').classList.remove('hidden');
                
                // Refresh data
                await loadStats();
                await loadPools();
                await loadUserStats();
                
            } catch (error) {
                console.error('Pool donation error:', error);
                
                if (error.code === 4001) {
                    alert('Transaction cancelled by user.');
                } else if (error.code === -32000) {
                    alert('Insufficient funds for gas. You need Base Sepolia ETH to pay for transaction fees.');
                } else if (error.message && error.message.includes('insufficient funds')) {
                    alert('Insufficient ETH balance. Please add more Base Sepolia ETH to your wallet.');
                } else {
                    alert('Transaction failed. Please try again. Error: ' + (error.message || 'Unknown error'));
                }
            } finally {
                donateBtn.textContent = 'Donate Now';
            }
        }

        // P2P donation functions
        function updateP2PEstimatedRewards() {
            const amount = parseFloat(document.getElementById('p2pAmount').value) || 0;
            const isPublic = document.getElementById('p2pPublic').checked;
            const basePoints = Math.max(Math.floor(amount * 1000), 0);
            const points = isPublic ? Math.floor(basePoints * 1.2) : basePoints; // 20% bonus for public
            // Update UI to show estimated points
        }

        async function processP2PDonation() {
            const recipient = document.getElementById('p2pRecipient').value.trim();
            const amount = document.getElementById('p2pAmount').value;
            const message = document.getElementById('p2pMessage').value.trim();
            const isPublic = document.getElementById('p2pPublic').checked;
            
            if (!recipient) {
                alert('Please enter a recipient address or username');
                return;
            }
            
            if (!amount || parseFloat(amount) < 0.001) {
                alert('Minimum donation is 0.001 ETH');
                return;
            }
            
            const donateBtn = document.getElementById('p2pDonateButtonText');
            donateBtn.textContent = 'Processing...';
            
            try {
                // Check user balance first
                const balanceWei = await web3.eth.getBalance(userAccount);
                const balanceEth = parseFloat(web3.utils.fromWei(balanceWei, 'ether'));
                const donationAmount = parseFloat(amount);
                
                if (balanceEth < donationAmount + 0.0001) {
                    alert(`Insufficient balance. You have ${balanceEth.toFixed(4)} ETH but need at least ${(donationAmount + 0.0001).toFixed(4)} ETH (including gas fees).`);
                    donateBtn.textContent = 'Send Donation';
                    return;
                }
                
                // Parse recipient (could be address or username)
                let recipientAddress = recipient;
                let recipientUsername = '';
                
                if (recipient.startsWith('@')) {
                    recipientUsername = recipient;
                    // For now, you'd need to resolve username to address
                    // This would require a lookup API
                    alert('Username resolution not yet implemented. Please use wallet address.');
                    donateBtn.textContent = 'Send Donation';
                    return;
                } else if (!recipient.startsWith('0x') || recipient.length !== 42) {
                    alert('Please enter a valid Ethereum address (0x...)');
                    donateBtn.textContent = 'Send Donation';
                    return;
                }
                
                // Send transaction
                const amountWei = web3.utils.toWei(amount, 'ether');
                
                const tx = await web3.eth.sendTransaction({
                    from: userAccount,
                    to: recipientAddress,
                    value: amountWei,
                    gas: 21000,
                });
                
                console.log('P2P donation successful:', tx);
                
                // Record donation in backend
                await fetch('/api/donate-to-user/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        donor_address: userAccount,
                        recipient_address: recipientAddress,
                        recipient_username: recipientUsername,
                        amount: amount,
                        message: message,
                        tx_hash: tx.transactionHash,
                        block_number: tx.blockNumber,
                        is_public: isPublic,
                        frame_interaction: false,
                    }),
                });
                
                // Show success
                document.getElementById('txHash').textContent = tx.transactionHash;
                const basePoints = Math.floor(parseFloat(amount) * 1000);
                const finalPoints = isPublic ? Math.floor(basePoints * 1.2) : basePoints;
                document.getElementById('pointsEarned').textContent = finalPoints;
                document.getElementById('tokensEarned').textContent = (parseFloat(amount) * 100 * (isPublic ? 1.2 : 1)).toFixed(1);
                
                // Clear form
                document.getElementById('p2pRecipient').value = '';
                document.getElementById('p2pAmount').value = '';
                document.getElementById('p2pMessage').value = '';
                
                document.getElementById('successModal').classList.remove('hidden');
                
                // Refresh data
                await loadStats();
                await loadUserStats();
                
            } catch (error) {
                console.error('P2P donation error:', error);
                
                if (error.code === 4001) {
                    alert('Transaction cancelled by user.');
                } else if (error.code === -32000) {
                    alert('Insufficient funds for gas. You need Base Sepolia ETH to pay for transaction fees.');
                } else if (error.message && error.message.includes('insufficient funds')) {
                    alert('Insufficient ETH balance. Please add more Base Sepolia ETH to your wallet.');
                } else {
                    alert('Transaction failed. Please try again. Error: ' + (error.message || 'Unknown error'));
                }
            } finally {
                donateBtn.textContent = 'Send Donation';
            }
        }

        // Legacy donation modal
        function openDonationModal(recipientId) {
            if (!userAccount) {
                alert('Please connect your wallet first!');
                return;
            }
            
            selectedRecipientId = recipientId;
            document.getElementById('donationModal').classList.remove('hidden');
            
            // Load recipient details
            fetch('/api/recipients/')
                .then(res => res.json())
                .then(data => {
                    const recipient = data.recipients.find(r => r.id === recipientId && !r.is_pool);
                    if (recipient) {
                        document.getElementById('selectedRecipient').innerHTML = `
                            <div class="glass-card rounded-2xl p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <h4 class="font-bold text-xl text-black">${recipient.name}</h4>
                                    <span class="px-3 py-2 bg-black/10 text-black rounded-full text-sm font-medium">
                                        ${getCategoryIcon(recipient.category)} ${recipient.category}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600 mb-4">${recipient.description}</p>
                                ${recipient.location ? `<div class="text-sm text-gray-500 mb-4">📍 ${recipient.location}</div>` : ''}
                                <div class="text-sm bg-black/5 p-3 rounded-xl">
                                    <span class="text-gray-500">Wallet:</span> 
                                    <span class="font-mono font-medium text-black">${recipient.wallet_address.substring(0, 10)}...${recipient.wallet_address.substring(32)}</span>
                                </div>
                            </div>
                        `;
                    }
                });
        }

        function closeDonationModal() {
            document.getElementById('donationModal').classList.add('hidden');
            document.getElementById('donationAmount').value = '';
            selectedRecipientId = null;
        }

        function updateEstimatedPoints() {
            const amount = parseFloat(document.getElementById('donationAmount').value) || 0;
            const points = Math.max(Math.floor(amount * 1000), 0);
            document.getElementById('estimatedPoints').textContent = points;
        }

        // Process legacy donation
        async function processDonation() {
            const amount = document.getElementById('donationAmount').value;
            
            if (!amount || parseFloat(amount) < 0.001) {
                alert('Minimum donation is 0.001 ETH');
                return;
            }
            
            if (!selectedRecipientId) return;
            
            const donateBtn = document.getElementById('donateButtonText');
            donateBtn.textContent = 'Processing...';
            
            try {
                // Check user balance first
                const balanceWei = await web3.eth.getBalance(userAccount);
                const balanceEth = parseFloat(web3.utils.fromWei(balanceWei, 'ether'));
                const donationAmount = parseFloat(amount);
                
                // Account for gas fees (roughly 0.0001 ETH for simple transfer)
                if (balanceEth < donationAmount + 0.0001) {
                    alert(`Insufficient balance. You have ${balanceEth.toFixed(4)} ETH but need at least ${(donationAmount + 0.0001).toFixed(4)} ETH (including gas fees).`);
                    donateBtn.textContent = 'Donate Now';
                    return;
                }
                
                // Get recipient wallet
                const response = await fetch('/api/recipients/');
                const data = await response.json();
                const recipient = data.recipients.find(r => r.id === selectedRecipientId && !r.is_pool);
                
                if (!recipient) {
                    alert('Recipient not found');
                    donateBtn.textContent = 'Donate Now';
                    return;
                }
                
                // Send transaction directly to recipient wallet
                const amountWei = web3.utils.toWei(amount, 'ether');
                
                console.log('Sending transaction:', {
                    from: userAccount,
                    to: recipient.wallet_address,
                    value: amountWei
                });
                
                const tx = await web3.eth.sendTransaction({
                    from: userAccount,
                    to: recipient.wallet_address,
                    value: amountWei,
                    gas: 21000, // Standard gas limit for ETH transfer
                });
                
                console.log('Transaction successful:', tx);
                
                // Record donation in backend
                await fetch('/api/record-donation/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        donor_address: userAccount,
                        recipient_id: selectedRecipientId,
                        amount: amount,
                        tx_hash: tx.transactionHash,
                        block_number: tx.blockNumber,
                    }),
                });
                
                // Show success
                document.getElementById('txHash').textContent = tx.transactionHash;
                document.getElementById('pointsEarned').textContent = Math.floor(parseFloat(amount) * 1000);
                document.getElementById('tokensEarned').textContent = (parseFloat(amount) * 100).toFixed(1);
                
                closeDonationModal();
                document.getElementById('successModal').classList.remove('hidden');
                
                // Refresh data
                await loadStats();
                await loadRecipients();
                await loadUserStats();
                
            } catch (error) {
                console.error('Donation error:', error);
                
                if (error.code === 4001) {
                    alert('Transaction cancelled by user.');
                } else if (error.code === -32000) {
                    alert('Insufficient funds for gas. You need Base Sepolia ETH to pay for transaction fees.');
                } else if (error.message && error.message.includes('insufficient funds')) {
                    alert('Insufficient ETH balance. Please add more Base Sepolia ETH to your wallet.');
                } else {
                    alert('Transaction failed. Please try again. Error: ' + (error.message || 'Unknown error'));
                }
            } finally {
                donateBtn.textContent = 'Donate Now';
            }
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            
            // Refresh current tab data
            const activeTab = document.querySelector('.tab-btn.tab-active')?.getAttribute('data-tab');
            if (activeTab === 'my-donations') {
                loadUserDonations();
            } else if (activeTab === 'leaderboard') {
                loadLeaderboard();
            } else if (activeTab === 'social') {
                loadSocialFeed();
            }
            
            // Refresh donate tab content based on current type
            if (activeTab === 'donate') {
                if (currentDonationType === 'pools') {
                    loadPools();
                } else if (currentDonationType === 'legacy') {
                    loadRecipients();
                }
            }
        }

        // Helper functions
        function getCategoryColor(category) {
            const colors = {
                'homeless': 'blue',
                'student': 'purple',
                'medical': 'pink',
                'emergency': 'red',
                'community': 'green',
                'creators': 'yellow',
                'development': 'indigo',
                'user': 'pink',
                'donation': 'blue'
            };
            return colors[category] || 'gray';
        }

        function getCategoryIcon(category) {
            const icons = {
                'homeless': '🏠',
                'student': '🎓',
                'medical': '🏥',
                'emergency': '🚨',
                'community': '🏘️',
                'creators': '🎨',
                'development': '⚡',
                'user': '👤',
                'donation': '💝'
            };
            return icons[category] || '📍';
        }

        function getUrgencyColor(level) {
            if (level >= 5) return 'red';
            if (level >= 4) return 'orange';
            if (level >= 3) return 'yellow';
            if (level >= 2) return 'blue';
            return 'gray';
        }

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    updateWalletUI();
                    loadUserStats();
                    loadUserProfile();
                    
                    // Refresh current tab if it's user-specific
                    const activeTab = document.querySelector('.tab-btn.tab-active')?.getAttribute('data-tab');
                    if (activeTab === 'my-donations') {
                        loadUserDonations();
                    } else if (activeTab === 'leaderboard') {
                        loadLeaderboard();
                    } else if (activeTab === 'profile') {
                        loadUserProfile();
                    }
                } else {
                    // User disconnected all accounts
                    disconnectWallet();
                }
            });

            // Listen for chain changes
            window.ethereum.on('chainChanged', (chainId) => {
                console.log('Chain changed to:', chainId);
                // Reload the page to avoid any state inconsistencies
                window.location.reload();
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Alt + 1-5 for quick tab switching
            if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        switchTab('donate');
                        break;
                    case '2':
                        e.preventDefault();
                        switchTab('social');
                        break;
                    case '3':
                        e.preventDefault();
                        switchTab('leaderboard');
                        break;
                    case '4':
                        e.preventDefault();
                        switchTab('my-donations');
                        break;
                    case '5':
                        e.preventDefault();
                        switchTab('profile');
                        break;
                }
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                document.getElementById('donationModal').classList.add('hidden');
                document.getElementById('poolDonationModal').classList.add('hidden');
                document.getElementById('successModal').classList.add('hidden');
                document.getElementById('walletDropdown').classList.add('hidden');
            }
        });

        // Auto-refresh data every 30 seconds when tab is active
        let refreshInterval;
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (!document.hidden) {
                    loadStats();
                    
                    const activeTab = document.querySelector('.tab-btn.tab-active')?.getAttribute('data-tab');
                    if (activeTab === 'social') {
                        // Refresh social feed silently
                        loadSocialFeed(1);
                    } else if (activeTab === 'leaderboard') {
                        loadLeaderboard();
                    }
                }
            }, 30000); // 30 seconds
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }
        
        // Start auto-refresh when page is visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
        
        // Start auto-refresh on load
        startAutoRefresh();

        // Error handling for failed API calls
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            // Don't show error to user for network issues, just log them
        });

        // Initialize default tab and donation type
        switchTab('donate');
        switchDonationType('pools');

        console.log('🌟 Umanity Global Donation Platform initialized!');
        console.log('💡 Use Alt+1-5 for quick tab navigation');
        console.log('🔧 Press F12 to open developer tools for debugging');
    </script>
</body>
</html>